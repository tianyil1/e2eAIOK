# Dockerfile for base env
# Used in ModelZoo: pipeline_test/bert

FROM intel/oneapi-aikit:2021.4-devel-ubuntu18.04

WORKDIR /root/
RUN apt-get update -y && apt-get install -y git
ENV PATH /opt/intel/oneapi/intelpython/latest/condabin:$PATH
SHELL ["conda", "run", "-n", "base", "/bin/bash", "-c"]

RUN python -m pip install  --no-cache-dir --ignore-installed sigopt==7.5.0
RUN python -m pip install transformers pandas
# install recdp
RUN python -m pip install pyrecdp
# for test
RUN python -m pip install pytest yapf pylint pylint-json2html

SHELL ["/bin/bash", "-c"]

RUN apt-get update -y && apt-get install -y openssh-server vim nano git \
            rsync wget curl gcc g++ build-essential pkg-config zlib1g-dev \
            zip unzip numactl flex ncurses-term python3 python3-pip openjdk-8-jdk
RUN sed -i 's/#Port 22/Port 12343/g' /etc/ssh/sshd_config
RUN sed -i 's/#   Port 22/    Port 12343/g' /etc/ssh/ssh_config
RUN mkdir /root/.ssh
COPY id_rsa /root/.ssh/id_rsa
RUN ssh-keygen -y -f /root/.ssh/id_rsa > /root/.ssh/id_rsa.pub
RUN cat /root/.ssh/id_rsa.pub > /root/.ssh/authorized_keys
RUN chmod 600 /root/.ssh/authorized_keys

# spark
RUN wget -qO- https://dlcdn.apache.org/spark/spark-3.2.1/spark-3.2.1-bin-hadoop3.2.tgz | tar xvz -C /home/
ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64
ENV SPARK_HOME /home/spark-3.2.1-bin-hadoop3.2
ENV PYTHONPATH $SPARK_HOME/python/:$PYTHONPATH
ENV PYTHONPATH $SPARK_HOME/python/lib/py4j-0.10.9.3-src.zip:$PYTHONPATH

RUN conda init bash
ENTRYPOINT [""]